!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("leancloud-realtime")):"function"==typeof define&&define.amd?define("groupchat-receipts",["exports","leancloud-realtime"],t):t((e=e||self).AV=e.AV||{},e.AV)}(this,function(e,t){"use strict";function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var r,o=(function(i,e){!function(e){var u=function(){},r=Object.prototype.hasOwnProperty,p=Object.create||function(e){var t=function(){};return t.prototype=e,new t},c=Object.keys||function(e){var t=[];for(var n in e)r.call(e,n)&&t.push(n);return t},f=function(e,t){for(var n in t)r.call(t,n)&&(e[n]=t[n]);return e},l=Object.setPrototypeOf||f,t=Object.prototype.toString,d=Array.isArray||function(e){return"[object Array]"===t.call(e)},m=function(e){return"[object Function]"===t.call(e)},y=!0,n={toString:""};for(var o in n)n.hasOwnProperty(o)&&(y=!1);var _=y?["toString","valueOf"]:null;function h(o,a,e){for(var t,n,r=function(e){var t=c(e);if(y)for(var n,r=0;n=_[r++];)e.hasOwnProperty(n)&&t.push(n);return t}(e),s=0,i=r.length;s<i;)"__self"!==(t=r[s++])&&(n=e[t],m(n)&&(!n.prototype||!n.prototype.__self)&&-1<n.toString().indexOf(".__base")?a[t]=function(e,n){var t=o[e]?o[e]:"__constructor"===e?a.__self.__parent:u,r=function(){var e=this.__base;this.__base=r.__base;var t=n.apply(this,arguments);return this.__base=e,t};return r.__base=t,r}(t,n):a[t]=n)}function g(e,t){for(var n,r=1;n=e[r++];)t?m(n)?a.self(t,n.prototype,n):a.self(t,n):t=m(n)?a(e[0],n.prototype,n):a(e[0],n);return t||e[0]}function a(){var e=arguments,t=d(e[0]),n=t||m(e[0]),r=n?t?g(e[0]):e[0]:u,o=e[n?1:0]||{},a=e[n?2:1],s=o.__constructor||n&&r.prototype&&r.prototype.__constructor?function(){return this.__constructor.apply(this,arguments)}:n?function(){return r.apply(this,arguments)}:function(){};if(!n)return s.prototype=o,s.prototype.__self=s.prototype.constructor=s,f(s,a);l(s,r);var i=(s.__parent=r).prototype,c=s.prototype=p(i);return c.__self=c.constructor=s,o&&h(i,c,o),a&&h(r,s,a),s}a.self=function(){var e=arguments,t=d(e[0])?g(e[0],e[0][0]):e[0],n=e[1],r=e[2],o=t.prototype;return n&&h(o,o,n),r&&h(t,t,r),t};var s=!0;i.exports=a,s=!1,"object"==typeof modules&&"function"==typeof modules.define&&(modules.define("inherit",function(e){e(a)}),s=!1),s&&(e.inherit=a)}(n)}(r={exports:{}},r.exports),r.exports);if(!t.TypedMessage)throw new Error("LeanCloud Realtime SDK not installed");var s=o(t.TypedMessage,{__constructor:function(e){this.__base(),this.timestamp=new Date(e)}});t.messageType(-101)(s),t.messageField(["timestamp"])(s),s.sendOptions={transient:!0};var i={name:"leancloud-realtime-plugin-groupchat-receipts",messageClasses:[s],onIMClientCreate:function(o){var a=o._sendReadCommand;o._sendReadCommand=function(e){e.forEach(function(e){!e.transient&&2<e.members.length&&e.send(new s(e.lastMessageAt||new Date)).catch(function(e){return console.warn("Sending groupchat receipt fail: ".concat(e.message))})});for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return a.call.apply(a,[o,e].concat(n))}},onConversationCreate:function(r){var o=r.queryMessages;r.queryMessages=function(){!r.transient&&2<r.members.length&&!r.lastReadTimestamps&&r._fetchAllReceiptTimestamps().then(function(e){r.lastReadTimestamps=e.reduce(function(e,t){var n=t.pid,r=t.lastReadAt;return Object.assign(e,a({},n,r))},{}),r.emit("lastreadtimestampsupdate",r.lastReadTimestamps)}).catch(function(e){return console.warn("Initialize group receipts fail: ".concat(e.message))});for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o.call.apply(o,[r].concat(t))}},beforeMessageDispatch:function(e,t){return e.type!==s.TYPE||(t.lastReadTimestamps&&(t.lastReadTimestamps[e.from]=e.timestamp,t.emit("lastreadtimestampsupdate",a({},e.from,e.timestamp))),!1)}};e.GroupchatReceiptsPlugin=i,e.ReadReceipt=s,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=groupchat-receipts.min.js.map

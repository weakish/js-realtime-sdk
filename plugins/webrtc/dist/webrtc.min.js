!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("leancloud-realtime")):"function"==typeof define&&define.amd?define("webrtc",["exports","leancloud-realtime"],n):n((e=e||self).AV=e.AV||{},e.AV)}(this,function(e,n){"use strict";function a(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,n){e.prototype=Object.create(n.prototype),(e.prototype.constructor=e).__proto__=n}function c(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=[],r=!0,o=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(t.push(a.value),!n||t.length!==n);r=!0);}catch(e){o=!0,i=e}finally{try{r||null==s.return||s.return()}finally{if(o)throw i}}return t}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(e,n){return e(n={exports:{}},n.exports),n.exports}var o=r(function(e){var r=Object.prototype.hasOwnProperty,p="~";function t(){}function s(e,n,t){this.fn=e,this.context=n,this.once=t||!1}function o(e,n,t,r,o){if("function"!=typeof t)throw new TypeError("The listener must be a function");var i=new s(t,r||e,o),a=p?p+n:n;return e._events[a]?e._events[a].fn?e._events[a]=[e._events[a],i]:e._events[a].push(i):(e._events[a]=i,e._eventsCount++),e}function u(e,n){0==--e._eventsCount?e._events=new t:delete e._events[n]}function n(){this._events=new t,this._eventsCount=0}Object.create&&(t.prototype=Object.create(null),(new t).__proto__||(p=!1)),n.prototype.eventNames=function(){var e,n,t=[];if(0===this._eventsCount)return t;for(n in e=this._events)r.call(e,n)&&t.push(p?n.slice(1):n);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t},n.prototype.listeners=function(e){var n=p?p+e:e,t=this._events[n];if(!t)return[];if(t.fn)return[t.fn];for(var r=0,o=t.length,i=new Array(o);r<o;r++)i[r]=t[r].fn;return i},n.prototype.listenerCount=function(e){var n=p?p+e:e,t=this._events[n];return t?t.fn?1:t.length:0},n.prototype.emit=function(e,n,t,r,o,i){var a=p?p+e:e;if(!this._events[a])return!1;var s,c,u=this._events[a],l=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),l){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,n),!0;case 3:return u.fn.call(u.context,n,t),!0;case 4:return u.fn.call(u.context,n,t,r),!0;case 5:return u.fn.call(u.context,n,t,r,o),!0;case 6:return u.fn.call(u.context,n,t,r,o,i),!0}for(c=1,s=new Array(l-1);c<l;c++)s[c-1]=arguments[c];u.fn.apply(u.context,s)}else{var f,h=u.length;for(c=0;c<h;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),l){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,n);break;case 3:u[c].fn.call(u[c].context,n,t);break;case 4:u[c].fn.call(u[c].context,n,t,r);break;default:if(!s)for(f=1,s=new Array(l-1);f<l;f++)s[f-1]=arguments[f];u[c].fn.apply(u[c].context,s)}}return!0},n.prototype.on=function(e,n,t){return o(this,e,n,t,!1)},n.prototype.once=function(e,n,t){return o(this,e,n,t,!0)},n.prototype.removeListener=function(e,n,t,r){var o=p?p+e:e;if(!this._events[o])return this;if(!n)return u(this,o),this;var i=this._events[o];if(i.fn)i.fn!==n||r&&!i.once||t&&i.context!==t||u(this,o);else{for(var a=0,s=[],c=i.length;a<c;a++)(i[a].fn!==n||r&&!i[a].once||t&&i[a].context!==t)&&s.push(i[a]);s.length?this._events[o]=1===s.length?s[0]:s:u(this,o)}return this},n.prototype.removeAllListeners=function(e){var n;return e?(n=p?p+e:e,this._events[n]&&u(this,n)):(this._events=new t,this._eventsCount=0),this},n.prototype.off=n.prototype.removeListener,n.prototype.addListener=n.prototype.on,n.prefixed=p,n.EventEmitter=n,e.exports=n}),u=r(function(e,n){var h;h={VERSION:"2.4.0",Result:{SUCCEEDED:1,NOTRANSITION:2,CANCELLED:3,PENDING:4},Error:{INVALID_TRANSITION:100,PENDING_TRANSITION:200,INVALID_CALLBACK:300},WILDCARD:"*",ASYNC:"async",create:function(e,n){var t="string"==typeof e.initial?{state:e.initial}:e.initial,r=e.terminal||e.final,o=n||e.target||{},i=e.events||[],a=e.callbacks||{},s={},c={},u=function(e){var n=Array.isArray(e.from)?e.from:e.from?[e.from]:[h.WILDCARD];s[e.name]=s[e.name]||{};for(var t=0;t<n.length;t++)c[n[t]]=c[n[t]]||[],c[n[t]].push(e.name),s[e.name][n[t]]=e.to||n[t];e.to&&(c[e.to]=c[e.to]||[])};t&&(t.event=t.event||"startup",u({name:t.event,from:"none",to:t.state}));for(var l=0;l<i.length;l++)u(i[l]);for(var f in s)s.hasOwnProperty(f)&&(o[f]=h.buildEvent(f,s[f]));for(var f in a)a.hasOwnProperty(f)&&(o[f]=a[f]);return o.current="none",o.is=function(e){return Array.isArray(e)?0<=e.indexOf(this.current):this.current===e},o.can=function(e){return!this.transition&&void 0!==s[e]&&(s[e].hasOwnProperty(this.current)||s[e].hasOwnProperty(h.WILDCARD))},o.cannot=function(e){return!this.can(e)},o.transitions=function(){return(c[this.current]||[]).concat(c[h.WILDCARD]||[])},o.isFinished=function(){return this.is(r)},o.error=e.error||function(e,n,t,r,o,i,a){throw a||i},o.states=function(){return Object.keys(c).sort()},t&&!t.defer&&o[t.event](),o},doCallback:function(n,e,t,r,o,i){if(e)try{return e.apply(n,[t,r,o].concat(i))}catch(e){return n.error(t,r,o,i,h.Error.INVALID_CALLBACK,"an exception occurred in a caller-provided callback function",e)}},beforeAnyEvent:function(e,n,t,r,o){return h.doCallback(e,e.onbeforeevent,n,t,r,o)},afterAnyEvent:function(e,n,t,r,o){return h.doCallback(e,e.onafterevent||e.onevent,n,t,r,o)},leaveAnyState:function(e,n,t,r,o){return h.doCallback(e,e.onleavestate,n,t,r,o)},enterAnyState:function(e,n,t,r,o){return h.doCallback(e,e.onenterstate||e.onstate,n,t,r,o)},changeState:function(e,n,t,r,o){return h.doCallback(e,e.onchangestate,n,t,r,o)},beforeThisEvent:function(e,n,t,r,o){return h.doCallback(e,e["onbefore"+n],n,t,r,o)},afterThisEvent:function(e,n,t,r,o){return h.doCallback(e,e["onafter"+n]||e["on"+n],n,t,r,o)},leaveThisState:function(e,n,t,r,o){return h.doCallback(e,e["onleave"+t],n,t,r,o)},enterThisState:function(e,n,t,r,o){return h.doCallback(e,e["onenter"+r]||e["on"+r],n,t,r,o)},beforeEvent:function(e,n,t,r,o){if(!1===h.beforeThisEvent(e,n,t,r,o)||!1===h.beforeAnyEvent(e,n,t,r,o))return!1},afterEvent:function(e,n,t,r,o){h.afterThisEvent(e,n,t,r,o),h.afterAnyEvent(e,n,t,r,o)},leaveState:function(e,n,t,r,o){var i=h.leaveThisState(e,n,t,r,o),a=h.leaveAnyState(e,n,t,r,o);return!1!==i&&!1!==a&&(h.ASYNC===i||h.ASYNC===a?h.ASYNC:void 0)},enterState:function(e,n,t,r,o){h.enterThisState(e,n,t,r,o),h.enterAnyState(e,n,t,r,o)},buildEvent:function(i,a){return function(){var e=this.current,n=a[e]||(a[h.WILDCARD]!=h.WILDCARD?a[h.WILDCARD]:e)||e,t=Array.prototype.slice.call(arguments);if(this.transition)return this.error(i,e,n,t,h.Error.PENDING_TRANSITION,"event "+i+" inappropriate because previous transition did not complete");if(this.cannot(i))return this.error(i,e,n,t,h.Error.INVALID_TRANSITION,"event "+i+" inappropriate in current state "+this.current);if(!1===h.beforeEvent(this,i,e,n,t))return h.Result.CANCELLED;if(e===n)return h.afterEvent(this,i,e,n,t),h.Result.NOTRANSITION;var r=this;this.transition=function(){return r.transition=null,r.current=n,h.enterState(r,i,e,n,t),h.changeState(r,i,e,n,t),h.afterEvent(r,i,e,n,t),h.Result.SUCCEEDED},this.transition.cancel=function(){r.transition=null,h.afterEvent(r,i,e,n,t)};var o=h.leaveState(this,i,e,n,t);return!1===o?(this.transition=null,h.Result.CANCELLED):h.ASYNC===o?h.Result.PENDING:this.transition?this.transition():void 0}}},e.exports&&(n=e.exports=h),n.StateMachine=h}),i=(u.StateMachine,r(function(s,e){!function(e){var u=function(){},r=Object.prototype.hasOwnProperty,l=Object.create||function(e){var n=function(){};return n.prototype=e,new n},c=Object.keys||function(e){var n=[];for(var t in e)r.call(e,t)&&n.push(t);return n},f=function(e,n){for(var t in n)r.call(n,t)&&(e[t]=n[t]);return e},h=Object.setPrototypeOf||f,n=Object.prototype.toString,p=Array.isArray||function(e){return"[object Array]"===n.call(e)},d=function(e){return"[object Function]"===n.call(e)},v=!0,t={toString:""};for(var o in t)t.hasOwnProperty(o)&&(v=!1);var _=v?["toString","valueOf"]:null;function y(o,i,e){for(var n,t,r=function(e){var n=c(e);if(v)for(var t,r=0;t=_[r++];)e.hasOwnProperty(t)&&n.push(t);return n}(e),a=0,s=r.length;a<s;)"__self"!==(n=r[a++])&&(t=e[n],d(t)&&(!t.prototype||!t.prototype.__self)&&-1<t.toString().indexOf(".__base")?i[n]=function(e,t){var n=o[e]?o[e]:"__constructor"===e?i.__self.__parent:u,r=function(){var e=this.__base;this.__base=r.__base;var n=t.apply(this,arguments);return this.__base=e,n};return r.__base=n,r}(n,t):i[n]=t)}function C(e,n){for(var t,r=1;t=e[r++];)n?d(t)?i.self(n,t.prototype,t):i.self(n,t):n=d(t)?i(e[0],t.prototype,t):i(e[0],t);return n||e[0]}function i(){var e=arguments,n=p(e[0]),t=n||d(e[0]),r=t?n?C(e[0]):e[0]:u,o=e[t?1:0]||{},i=e[t?2:1],a=o.__constructor||t&&r.prototype&&r.prototype.__constructor?function(){return this.__constructor.apply(this,arguments)}:t?function(){return r.apply(this,arguments)}:function(){};if(!t)return a.prototype=o,a.prototype.__self=a.prototype.constructor=a,f(a,i);h(a,r);var s=(a.__parent=r).prototype,c=a.prototype=l(s);return c.__self=c.constructor=a,o&&y(s,c,o),i&&y(r,a,i),a}i.self=function(){var e=arguments,n=p(e[0])?C(e[0],e[0][0]):e[0],t=e[1],r=e[2],o=n.prototype;return t&&y(o,o,t),r&&y(n,n,r),n};var a=!0;s.exports=i,a=!1,"object"==typeof modules&&"function"==typeof modules.define&&(modules.define("inherit",function(e){e(i)}),a=!1),a&&(e.inherit=i)}(t)}));if(!n.TypedMessage)throw new Error("LeanCloud Realtime SDK not installed");var l,f=i(n.TypedMessage,{__constructor:function(e){this.__base(),this.payload=e}});f.sendOptions={transient:!0},n.messageField("payload")(f);var h,p,d,v,_=n.messageType(-102)(l=function(e){function n(){return e.apply(this,arguments)||this}return s(n,e),n}(f))||l,y=n.messageType(-103)(h=function(e){function n(){return e.apply(this,arguments)||this}return s(n,e),n}(f))||h,C=n.messageType(-104)(p=function(e){function n(){return e.apply(this,arguments)||this}return s(n,e),n}(f))||p,m=n.messageType(-105)(d=function(e){function n(){return e.apply(this,arguments)||this}return s(n,e),n}(f))||d,g=function(i){function e(e,n){var t;(t=i.call(this)||this)._setConversation(e),t._peerConnection=t._createPeerConnection(n),t._call=u.create({initial:"calling",events:[{name:"connect",from:"calling",to:"connected"},{name:"close",from:"connected",to:"closed"},{name:"cancel",from:"calling",to:"canceled"},{name:"refuse",from:"calling",to:"refused"}]}),t._promises={};var r=new Promise(function(e){t._promises.resolveStreamReady=e}),o=new Promise(function(e){t._promises.resolveAccept=e});return Promise.all([r,o]).then(function(e){var n=c(e,1)[0];t._call.can("connect")&&(t._call.connect(),t.emit("connect",n))}),t}s(e,i);var n,t,r,o=e.prototype;return o.close=function(){var e=this;return Promise.resolve().then(function(){e._call.close(),e._destroyPeerConnection(),e._peerConnection.close(),e._destroy()})},o._handleCloseEvent=function(){this._call.can("close")&&(this.close(),this.emit("close"))},o._setConversation=function(e){this._conversation&&this._conversation.off("message"),e&&(this._conversation=e).on("message",this._handleMessage.bind(this))},o._destroy=function(){this._conversation.off("message")},o._createPeerConnection=function(e){var n=new RTCPeerConnection(e);return n.onicecandidate=this._handleICECandidateEvent.bind(this),n.onaddstream=this._handleAddStreamEvent.bind(this),n.onnremovestream=this._handleRemoveStreamEvent.bind(this),n.oniceconnectionstatechange=this._handleICEConnectionStateChangeEvent.bind(this),n.onsignalingstatechange=this._handleSignalingStateChangeEvent.bind(this),n},o._destroyPeerConnection=function(){var e=this._peerConnection;delete e.onaddstream,delete e.onremovestream,delete e.onnicecandidate,delete e.oniceconnectionstatechange,delete e.onsignalingstatechange},o._handleMessage=function(e){return e instanceof _?this._handleAnswer(e):e instanceof C?this._handleRefusal():e instanceof m?this._handleCancelation():e instanceof y&&this._handleICECandidate(e)},o._handleICECandidate=function(e){var n=new RTCIceCandidate(e.payload);this._peerConnection&&this._peerConnection.addIceCandidate(n).catch(console.error.bind(console))},o._handleICECandidateEvent=function(e){return!(!e.candidate||!this._conversation)&&this._conversation.send(new y(e.candidate)).catch(console.error.bind(console))},o._handleAddStreamEvent=function(e){this._promises.resolveStreamReady(e.stream)},o._handleRemoveStreamEvent=function(){this._handleCloseEvent()},o._handleICEConnectionStateChangeEvent=function(){switch(this._peerConnection.iceConnectionState){case"closed":case"failed":case"disconnected":this._handleCloseEvent()}},o._handleSignalingStateChangeEvent=function(){switch(this._peerConnection.signalingState){case"closed":this._handleCloseEvent()}},o._handleAnswer=function(){throw new Error("not implemented")},o._handleRefusal=function(){throw new Error("not implemented")},o._handleCancelation=function(){throw new Error("not implemented")},n=e,(t=[{key:"state",get:function(){return this._call.current}}])&&a(n.prototype,t),r&&a(n,r),e}(o),w=function(o){function e(e,n,t){var r;return(r=o.call(this,n,t)||this).to=e,r}s(e,o);var n=e.prototype;return n._handleAnswer=function(e){var n=new RTCSessionDescription(e.payload);this._peerConnection.setRemoteDescription(n),this._promises.resolveAccept()},n._handleRefusal=function(){this._destroyPeerConnection(),this._call.refuse(),this.emit("refuse"),this._destroy()},n.cancel=function(){var e=this;return this._call.cancel(),this._conversation.send(new m).then(function(){return e._destroy()})},n.close=function(){return this._call.can("cancel")?this.cancel():o.prototype.close.call(this)},e}(g),b=function(i){function e(e,n,t){var r;(r=i.call(this,n,t)||this).from=e.from;var o=new RTCSessionDescription(e.payload);return r._handleOfferPromise=r._peerConnection.setRemoteDescription(o),r}s(e,i);var n=e.prototype;return n.accept=function(e){var n=this;if(!e)throw new TypeError("a MediaStream instance is required to accept a call");return this._handleOfferPromise.then(function(){return n._peerConnection.addStream(e)}).then(function(){return n._peerConnection.createAnswer()}).then(function(e){return n._peerConnection.setLocalDescription(e)}).then(function(){return n._conversation.send(new _(n._peerConnection.localDescription))}).then(function(){return n._promises.resolveAccept()})},n.refuse=function(){var e=this;return this._conversation.send(new C).then(function(){e._call.refuse(),e._destroy()})},n._handleCancelation=function(){this._call.cancel(),this.emit("cancel"),this._destroy()},e}(g),E=n.messageType(-101)(v=function(e){function n(){return e.apply(this,arguments)||this}return s(n,e),n}(f))||v,A={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302","stun:stun3.l.google.com:19302","stun:stun4.l.google.com:19302","stun:stun.ekiga.net","stun:stun.ideasip.com","stun:stun.rixtelecom.se","stun:stun.schlund.de","stun:stun.stunprotocol.org:3478","stun:stun.voiparound.com","stun:stun.voipbuster.com","stun:stun.voipstunt.com","stun:stun.voxgratia.org"]}]},S=function(r){function e(e,n){var t;if("string"!=typeof e)throw new TypeError("id is not a string");return(t=r.call(this)||this).id=e,t.options=Object.assign({RTCConfiguration:A},n),t}s(e,r);var n=e.prototype;return n._open=function(e,n){var r=this;return e.createIMClient(this.id,n,"webrtc").then(function(e){return r._imClient=e,r.id=e.id,e.on("message",function(e,n){return e instanceof E&&r._handleOffer(e,n)}),e.on("conflict",function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return r.emit.apply(r,["conflict"].concat(n))}),r})},n.close=function(){return this._imClient.close()},n.call=function(r,o){var i=this;if("string"!=typeof r)throw new TypeError("target id is not a string");if(!o)throw new TypeError("a MediaStream instance is required to make a call");return this._imClient.ping([r]).then(function(e){if(!e.length)throw new Error("Call failed as ".concat(r," is not online"));var t=new w(r,null,i.options.RTCConfiguration),n=new Promise(function(e){t._peerConnection.onnegotiationneeded=e});return t._peerConnection.addStream(o),n.then(function(){return Promise.all([i._imClient.createConversation({members:[r],unique:!0}),t._peerConnection.createOffer().then(function(e){t._peerConnection.setLocalDescription(e)})])}).then(function(e){var n=c(e,1)[0];return t._setConversation(n),n.send(new E(t._peerConnection.localDescription))}).then(function(){return t})})},n._handleOffer=function(e,n){var t=new b(e,n,this.options.RTCConfiguration);this.emit("call",t)},e}(o),T={name:"leancloud-realtime-plugin-webrtc",messageClasses:[E,_,y,C,m],onRealtimeCreate:function(t){t.createWebRTCClient=function(e,n){return new S(e)._open(t,n)}}},O=!!(window.RTCPeerConnection&&window.RTCSessionDescription&&window.RTCIceCandidate);e.WebRTCPlugin=T,e.isWebRTCSupported=O,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=webrtc.min.js.map

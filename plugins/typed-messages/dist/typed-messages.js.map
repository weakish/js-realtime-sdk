{"version":3,"file":"typed-messages.js","sources":["../src/storage.js","../src/realtime.js","../src/file-message.js","../src/image-message.js","../src/audio-message.js","../src/video-message.js","../src/location-message.js","../src/index.js"],"sourcesContent":["/* eslint-disable import/no-unresolved */\nimport { File } from 'leancloud-storage';\n\nif (!File) {\n  throw new Error('LeanCloud Storage SDK not installed');\n}\n\nexport { File, GeoPoint } from 'leancloud-storage';\n","/* eslint-disable import/no-unresolved */\nimport { TypedMessage } from 'leancloud-realtime';\n\nif (!TypedMessage) {\n  throw new Error('LeanCloud Realtime SDK not installed');\n}\n\nexport {\n  TypedMessage,\n  messageType,\n  messageField,\n  IE10Compatible,\n} from 'leancloud-realtime';\n","import { File } from './storage';\nimport {\n  TypedMessage,\n  messageType,\n  messageField,\n  IE10Compatible,\n} from './realtime';\n\nexport default class FileMessage extends TypedMessage {\n  /**\n   * @extends TypedMessage\n   * @param  {AV.File} file LeanCloud 存储 SDK 中的 AV.File 实例，且必须是已经保存到服务端上的 File 实例\n   * （如果是刚刚创建的，必须 save 后才能用于创建 FileMessage）\n   */\n  constructor(file) {\n    if (!(file instanceof File)) {\n      throw new TypeError('file must be an AV.File');\n    }\n    if (typeof file.id !== 'string') {\n      throw new Error('file must be saved before used to create a Message');\n    }\n    super();\n    this._file = file;\n    this._lcfile = {\n      objId: file.id,\n      url: file.url(),\n      metaData: Object.assign(file.metaData() || {}, {\n        name: file.name(),\n      }),\n    };\n  }\n\n  /**\n   * 在客户端需要以文本形式展示该消息时显示的文案，格式为 <code>[类型] file.name()</code>\n   * @type {String}\n   * @readonly\n   */\n  get summary() {\n    return `[${this.constructor._summaryType}] ${this._file.name() ||\n      ''}`.trim();\n  }\n\n  /**\n   * 获得 file 对象\n   * @return {AV.File}\n   */\n  getFile() {\n    return this._file;\n  }\n\n  toJSON() {\n    return {\n      ...super.toJSON(),\n      file: this.getFile().toJSON(),\n    };\n  }\n\n  static _parseFileFromRawData(data) {\n    if (!(data && data._lcfile)) {\n      throw new Error('malformed FileMessage content');\n    }\n    let id = data._lcfile.objId;\n    if (typeof id !== 'string') {\n      id = '';\n    }\n    const file = File.createWithoutData(id);\n    file.attributes = file.attributes || {};\n    file._url = data._lcfile.url;\n    file.attributes.url = file._url;\n    file._metaData = data._lcfile.metaData || {};\n    file.attributes.metaData = file._metaData;\n    if (data._lcfile.metaData) {\n      file._name = data._lcfile.metaData.name;\n      file.attributes.name = file._name;\n    }\n    return file;\n  }\n\n  static parse(json, message) {\n    const file = this._parseFileFromRawData(json);\n    return TypedMessage.parse(json, message || new this(file));\n  }\n}\n\nFileMessage._summaryType = '文件';\n\n/**\n * @name TYPE\n * @memberof FileMessage\n * @type Number\n * @static\n * @const\n */\nmessageType(-6)(FileMessage);\nmessageField('_lcfile')(FileMessage);\nIE10Compatible(FileMessage);\n","import FileMessage from './file-message';\nimport { messageType, IE10Compatible } from './realtime';\n\n/**\n * 构造方法参数同 {@link FileMessage}\n *\n * @extends FileMessage\n */\nclass ImageMessage extends FileMessage {}\nImageMessage._summaryType = '图片';\n\n/**\n * @name TYPE\n * @memberof ImageMessage\n * @type Number\n * @static\n * @const\n */\nmessageType(-2)(ImageMessage);\nIE10Compatible(ImageMessage);\n\nexport default ImageMessage;\n","import FileMessage from './file-message';\nimport { messageType, IE10Compatible } from './realtime';\n\n/**\n * 构造方法参数同 {@link FileMessage}\n *\n * @extends FileMessage\n */\nclass AudioMessage extends FileMessage {}\nAudioMessage._summaryType = '语音';\n\n/**\n * @name TYPE\n * @memberof AudioMessage\n * @type Number\n * @static\n * @const\n */\nmessageType(-3)(AudioMessage);\nIE10Compatible(AudioMessage);\n\nexport default AudioMessage;\n","import FileMessage from './file-message';\nimport { messageType, IE10Compatible } from './realtime';\n\n/**\n * 构造方法参数同 {@link FileMessage}\n *\n * @extends FileMessage\n */\nclass VideoMessage extends FileMessage {}\nVideoMessage._summaryType = '视频';\n\n/**\n * @name TYPE\n * @memberof VideoMessage\n * @type Number\n * @static\n * @const\n */\nmessageType(-4)(VideoMessage);\nIE10Compatible(VideoMessage);\n\nexport default VideoMessage;\n","import { GeoPoint } from './storage';\nimport {\n  TypedMessage,\n  messageType,\n  messageField,\n  IE10Compatible,\n} from './realtime';\n\nexport default class LocationMessage extends TypedMessage {\n  /**\n   * @extends TypedMessage\n   * @param  {AV.GeoPoint} geoPoint LeanCloud 存储 SDK 中的 AV.GeoPoint 实例\n   */\n  constructor(geoPoint) {\n    if (!(geoPoint instanceof GeoPoint)) {\n      throw new TypeError('geoPoint must be an AV.GeoPoint');\n    }\n    super();\n    this._geoPoint = geoPoint;\n    const { latitude, longitude } = geoPoint;\n    this._lcloc = { latitude, longitude };\n  }\n\n  /**\n   * 在客户端需要以文本形式展示该消息时显示的文案，格式为 <code>[位置] message.text</code>\n   * @type {String}\n   * @readonly\n   */\n  get summary() {\n    return `[位置] ${this.text || ''}`.trim();\n  }\n\n  /**\n   * 获得 geoPoint 对象\n   * @return {AV.GeoPoint}\n   */\n  getLocation() {\n    return this._geoPoint;\n  }\n\n  toJSON() {\n    return {\n      ...super.toJSON(),\n      location: this.getLocation().toJSON(),\n    };\n  }\n\n  static parse(json, message) {\n    const { latitude, longitude } = json._lcloc;\n    const geoPoint = new GeoPoint({ latitude, longitude });\n    return TypedMessage.parse(json, message || new this(geoPoint));\n  }\n}\n\n/**\n * @name TYPE\n * @memberof LocationMessage\n * @type Number\n * @static\n * @const\n */\nmessageType(-5)(LocationMessage);\nmessageField('_lcloc')(LocationMessage);\nIE10Compatible(LocationMessage);\n","/** @module leancloud-realtime-plugin-typed-messages */\n\nimport FileMessage from './file-message';\nimport ImageMessage from './image-message';\nimport AudioMessage from './audio-message';\nimport VideoMessage from './video-message';\nimport LocationMessage from './location-message';\nimport { name } from '../package.json';\n\n/**\n * TypedMessages 插件，使用后可支持接收 LeanCloud 提供的富媒体类型的消息\n * @example\n * var realtime = new Realtime({\n *   appId: appId,\n *   plugins: TypedMessagesPlugin,\n * });\n */\nexport const TypedMessagesPlugin = {\n  name,\n  messageClasses: [\n    FileMessage,\n    ImageMessage,\n    AudioMessage,\n    VideoMessage,\n    LocationMessage,\n  ],\n};\n\nexport {\n  /**\n   * @see FileMessage\n   */\n  FileMessage,\n  /**\n   * @see ImageMessage\n   */\n  ImageMessage,\n  /**\n   * @see AudioMessage\n   */\n  AudioMessage,\n  /**\n   * @see VideoMessage\n   */\n  VideoMessage,\n  /**\n   * @see LocationMessage\n   */\n  LocationMessage,\n};\n"],"names":["File","Error","TypedMessage","FileMessage","file","TypeError","id","_file","_lcfile","objId","url","metaData","Object","assign","name","getFile","toJSON","_parseFileFromRawData","data","createWithoutData","attributes","_url","_metaData","_name","parse","json","message","constructor","_summaryType","trim","messageType","messageField","IE10Compatible","ImageMessage","AudioMessage","VideoMessage","LocationMessage","geoPoint","GeoPoint","_geoPoint","latitude","longitude","_lcloc","getLocation","location","text","TypedMessagesPlugin","messageClasses"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EAAA;AACA;EAEA,IAAI,CAACA,qBAAL,EAAW;EACT,QAAM,IAAIC,KAAJ,CAAU,qCAAV,CAAN;EACD;;ECLD;AACA;EAEA,IAAI,CAACC,8BAAL,EAAmB;EACjB,QAAM,IAAID,KAAJ,CAAU,sCAAV,CAAN;EACD;;MCGoBE;;;;;EACnB;;;;;EAKA,uBAAYC,IAAZ,EAAkB;EAAA;;EAChB,QAAI,EAAEA,IAAI,YAAYJ,qBAAlB,CAAJ,EAA6B;EAC3B,YAAM,IAAIK,SAAJ,CAAc,yBAAd,CAAN;EACD;;EACD,QAAI,OAAOD,IAAI,CAACE,EAAZ,KAAmB,QAAvB,EAAiC;EAC/B,YAAM,IAAIL,KAAJ,CAAU,oDAAV,CAAN;EACD;;EACD;EACA,UAAKM,KAAL,GAAaH,IAAb;EACA,UAAKI,OAAL,GAAe;EACbC,MAAAA,KAAK,EAAEL,IAAI,CAACE,EADC;EAEbI,MAAAA,GAAG,EAAEN,IAAI,CAACM,GAAL,EAFQ;EAGbC,MAAAA,QAAQ,EAAEC,MAAM,CAACC,MAAP,CAAcT,IAAI,CAACO,QAAL,MAAmB,EAAjC,EAAqC;EAC7CG,QAAAA,IAAI,EAAEV,IAAI,CAACU,IAAL;EADuC,OAArC;EAHG,KAAf;EATgB;EAgBjB;EAED;;;;;;;;;EAUA;;;;WAIAC,UAAA,mBAAU;EACR,WAAO,KAAKR,KAAZ;EACD;;WAEDS,SAAA,kBAAS;EACP,qDACWA,MADX;EAEEZ,MAAAA,IAAI,EAAE,KAAKW,OAAL,GAAeC,MAAf;EAFR;EAID;;gBAEMC,wBAAP,+BAA6BC,IAA7B,EAAmC;EACjC,QAAI,EAAEA,IAAI,IAAIA,IAAI,CAACV,OAAf,CAAJ,EAA6B;EAC3B,YAAM,IAAIP,KAAJ,CAAU,+BAAV,CAAN;EACD;;EACD,QAAIK,EAAE,GAAGY,IAAI,CAACV,OAAL,CAAaC,KAAtB;;EACA,QAAI,OAAOH,EAAP,KAAc,QAAlB,EAA4B;EAC1BA,MAAAA,EAAE,GAAG,EAAL;EACD;;EACD,QAAMF,IAAI,GAAGJ,qBAAI,CAACmB,iBAAL,CAAuBb,EAAvB,CAAb;EACAF,IAAAA,IAAI,CAACgB,UAAL,GAAkBhB,IAAI,CAACgB,UAAL,IAAmB,EAArC;EACAhB,IAAAA,IAAI,CAACiB,IAAL,GAAYH,IAAI,CAACV,OAAL,CAAaE,GAAzB;EACAN,IAAAA,IAAI,CAACgB,UAAL,CAAgBV,GAAhB,GAAsBN,IAAI,CAACiB,IAA3B;EACAjB,IAAAA,IAAI,CAACkB,SAAL,GAAiBJ,IAAI,CAACV,OAAL,CAAaG,QAAb,IAAyB,EAA1C;EACAP,IAAAA,IAAI,CAACgB,UAAL,CAAgBT,QAAhB,GAA2BP,IAAI,CAACkB,SAAhC;;EACA,QAAIJ,IAAI,CAACV,OAAL,CAAaG,QAAjB,EAA2B;EACzBP,MAAAA,IAAI,CAACmB,KAAL,GAAaL,IAAI,CAACV,OAAL,CAAaG,QAAb,CAAsBG,IAAnC;EACAV,MAAAA,IAAI,CAACgB,UAAL,CAAgBN,IAAhB,GAAuBV,IAAI,CAACmB,KAA5B;EACD;;EACD,WAAOnB,IAAP;EACD;;gBAEMoB,QAAP,eAAaC,IAAb,EAAmBC,OAAnB,EAA4B;EAC1B,QAAMtB,IAAI,GAAG,KAAKa,qBAAL,CAA2BQ,IAA3B,CAAb;;EACA,WAAOvB,8BAAY,CAACsB,KAAb,CAAmBC,IAAnB,EAAyBC,OAAO,IAAI,IAAI,IAAJ,CAAStB,IAAT,CAApC,CAAP;EACD;;;;0BA5Ca;EACZ,aAAO,WAAI,KAAKuB,WAAL,CAAiBC,YAArB,eAAsC,KAAKrB,KAAL,CAAWO,IAAX,MAC3C,EADK,EACAe,IADA,EAAP;EAED;;;;IAhCsC3B;EA4EzCC,WAAW,CAACyB,YAAZ,GAA2B,IAA3B;EAEA;;;;;;;;AAOAE,+BAAW,CAAC,CAAC,CAAF,CAAX,CAAgB3B,WAAhB;AACA4B,gCAAY,CAAC,SAAD,CAAZ,CAAwB5B,WAAxB;AACA6B,kCAAc,CAAC7B,WAAD,CAAd;;EC5FA;;;;;;MAKM8B;;;;;;;;;;IAAqB9B;;EAC3B8B,YAAY,CAACL,YAAb,GAA4B,IAA5B;EAEA;;;;;;;;AAOAE,+BAAW,CAAC,CAAC,CAAF,CAAX,CAAgBG,YAAhB;AACAD,kCAAc,CAACC,YAAD,CAAd;;EChBA;;;;;;MAKMC;;;;;;;;;;IAAqB/B;;EAC3B+B,YAAY,CAACN,YAAb,GAA4B,IAA5B;EAEA;;;;;;;;AAOAE,+BAAW,CAAC,CAAC,CAAF,CAAX,CAAgBI,YAAhB;AACAF,kCAAc,CAACE,YAAD,CAAd;;EChBA;;;;;;MAKMC;;;;;;;;;;IAAqBhC;;EAC3BgC,YAAY,CAACP,YAAb,GAA4B,IAA5B;EAEA;;;;;;;;AAOAE,+BAAW,CAAC,CAAC,CAAF,CAAX,CAAgBK,YAAhB;AACAH,kCAAc,CAACG,YAAD,CAAd;;MCXqBC;;;;;EACnB;;;;EAIA,2BAAYC,QAAZ,EAAsB;EAAA;;EACpB,QAAI,EAAEA,QAAQ,YAAYC,yBAAtB,CAAJ,EAAqC;EACnC,YAAM,IAAIjC,SAAJ,CAAc,iCAAd,CAAN;EACD;;EACD;EACA,UAAKkC,SAAL,GAAiBF,QAAjB;EALoB,QAMZG,QANY,GAMYH,QANZ,CAMZG,QANY;EAAA,QAMFC,SANE,GAMYJ,QANZ,CAMFI,SANE;EAOpB,UAAKC,MAAL,GAAc;EAAEF,MAAAA,QAAQ,EAARA,QAAF;EAAYC,MAAAA,SAAS,EAATA;EAAZ,KAAd;EAPoB;EAQrB;EAED;;;;;;;;;EASA;;;;WAIAE,cAAA,uBAAc;EACZ,WAAO,KAAKJ,SAAZ;EACD;;WAEDvB,SAAA,kBAAS;EACP,qDACWA,MADX;EAEE4B,MAAAA,QAAQ,EAAE,KAAKD,WAAL,GAAmB3B,MAAnB;EAFZ;EAID;;oBAEMQ,QAAP,eAAaC,IAAb,EAAmBC,OAAnB,EAA4B;EAAA,uBACMD,IAAI,CAACiB,MADX;EAAA,QAClBF,QADkB,gBAClBA,QADkB;EAAA,QACRC,SADQ,gBACRA,SADQ;EAE1B,QAAMJ,QAAQ,GAAG,IAAIC,yBAAJ,CAAa;EAAEE,MAAAA,QAAQ,EAARA,QAAF;EAAYC,MAAAA,SAAS,EAATA;EAAZ,KAAb,CAAjB;EACA,WAAOvC,8BAAY,CAACsB,KAAb,CAAmBC,IAAnB,EAAyBC,OAAO,IAAI,IAAI,IAAJ,CAASW,QAAT,CAApC,CAAP;EACD;;;;0BAvBa;EACZ,aAAO,yBAAQ,KAAKQ,IAAL,IAAa,EAArB,EAA0BhB,IAA1B,EAAP;EACD;;;;IAtB0C3B;AA8C7C,AAOA4B,+BAAW,CAAC,CAAC,CAAF,CAAX,CAAgBM,eAAhB;AACAL,gCAAY,CAAC,QAAD,CAAZ,CAAuBK,eAAvB;AACAJ,kCAAc,CAACI,eAAD,CAAd;;;;EC/DA;AAEA,EAOA;;;;;;;;;AAQA,MAAaU,mBAAmB,GAAG;EACjChC,EAAAA,IAAI,EAAJA,IADiC;EAEjCiC,EAAAA,cAAc,EAAE,CACd5C,WADc,EAEd8B,YAFc,EAGdC,YAHc,EAIdC,YAJc,EAKdC,eALc;EAFiB,CAA5B;;;;;;;;;;;;;;;;;"}